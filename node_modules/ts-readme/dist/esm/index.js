import _regeneratorRuntime from"@babel/runtime/regenerator";import _asyncToGenerator from"@babel/runtime/helpers/asyncToGenerator";import _toConsumableArray from"@babel/runtime/helpers/toConsumableArray";import _slicedToArray from"@babel/runtime/helpers/slicedToArray";import ts from"typescript";import fs from"fs";import prettier from"prettier";import glob from"fast-glob";var printer=ts.createPrinter({newLine:ts.NewLineKind.LineFeed});function getJsDocComment(statement){return statement.jsDoc&&statement.jsDoc[0]?statement.jsDoc[0].comment:""}function isArrowConst(statement){return Boolean(ts.isVariableStatement(statement)&&statement.declarationList.declarations[0].initializer&&ts.isArrowFunction(statement.declarationList.declarations[0].initializer))}function getType(statement){if(isArrowConst(statement)||ts.isFunctionLike(statement)){return"function"}if(ts.isTypeAliasDeclaration(statement)){return"type"}if(ts.isClassDeclaration(statement)){return"class"}if(ts.isInterfaceDeclaration(statement)){return"interface"}if(ts.isVariableStatement(statement)){if(statement.declarationList.declarations[0].type){return"variable: ".concat(printer.printNode(ts.EmitHint.Unspecified,statement.declarationList.declarations[0].type,statement.getSourceFile()))}return"variable"}}function print(param){return printer.printNode(ts.EmitHint.Unspecified,param,param.getSourceFile())}export function generateMarkdown(doc){var headerDepth=arguments.length>1&&arguments[1]!==undefined?arguments[1]:3;var result="".concat(Array(headerDepth).fill("#").join("")," `").concat(doc.title,"` (").concat(doc.type,")\n\n");if(doc.description){result+="".concat(doc.description,"\n\n")}if(doc.params&&doc.params.length>0){result+="**Parameters:**\n\n";doc.params.forEach(function(param){result+="- ".concat(param.name," ").concat(param.type?"(`".concat(param.type,"`) "):"").concat(param.description?"- ".concat(param.description):"","\n")});result+="\n"}if(doc.properties&&doc.properties.length>0){result+="**Properties:**\n\n";doc.properties.forEach(function(property){result+="- ".concat(property,"\n")});result+="\n"}if(doc.members&&doc.members.length>0){result+="**Members:**\n\n";doc.members.forEach(function(member){result+="- ".concat(member,"\n")});result+="\n"}if(doc.returnType){result+="**returns:** ".concat(doc.returnType,"\n\n")}if(doc.examples&&doc.examples.length>0){doc.examples.forEach(function(example){result+="".concat(example.includes("```")?example:"```tsx\n".concat(example,"\n```\n"),"\n")});result+="\n"}return result}function getDocs(filenames){var program=ts.createProgram({rootNames:filenames,options:{}});var checker=program.getTypeChecker();function getParamType(doc,statement){var name=print(doc.name);var fn=isArrowConst(statement)?statement.declarationList.declarations[0].initializer:statement;if(!fn||!ts.isFunctionLike(fn)){return""}var paramType=fn.parameters.find(function(param){return print(param.name)===name});return paramType?checker.typeToString(checker.getTypeAtLocation(paramType)):""}var docs=program.getSourceFiles().filter(function(file){return!file.isDeclarationFile}).map(function(file){return file.statements.filter(function(s){return Boolean(s.modifiers&&s.modifiers.find(function(e){return e.kind===ts.SyntaxKind.ExportKeyword})&&(ts.isVariableStatement(s)||ts.isFunctionLike(s)||ts.isTypeAliasDeclaration(s)||ts.isClassDeclaration(s)||ts.isInterfaceDeclaration(s)))}).map(function(statement){var title=ts.isVariableStatement(statement)?print(statement.declarationList.declarations[0].name):statement.name&&print(statement.name)||"";var description=getJsDocComment(statement);var jsDocs=ts.getJSDocTags(statement);var returnType;var params=jsDocs.filter(ts.isJSDocParameterTag).map(function(doc){return{name:print(doc.name),description:doc.comment?doc.comment.replace(/^- /,""):"",type:getParamType(doc,statement)}});if(ts.isFunctionLike(statement)){statement.parameters.forEach(function(param){var paramName=print(param.name);if(params.find(function(p){return p.name===paramName})){return}params.push({name:paramName,type:checker.typeToString(checker.getTypeAtLocation(param))})});var type=checker.getTypeAtLocation(statement);var _type$getCallSignatur=type.getCallSignatures().map(function(sig){return checker.typeToString(checker.getReturnTypeOfSignature(sig))});var _type$getCallSignatur2=_slicedToArray(_type$getCallSignatur,1);returnType=_type$getCallSignatur2[0]}var members=[];if(ts.isInterfaceDeclaration(statement)){members=statement.members.map(function(member){var memberDescription=getJsDocComment(member);return"".concat(print(member.name).replace(/\/\*\*.*\*\/\s+(\S+)/,"$1")," (`").concat(checker.typeToString(checker.getTypeAtLocation(member)),"`)").concat(memberDescription?" - ".concat(memberDescription):"")})}var examples=jsDocs.filter(function(doc){return doc.tagName.escapedText==="example"}).map(function(doc){return doc.comment}).filter(function(doc){return Boolean(doc)});var properties=jsDocs.filter(function(doc){return doc.tagName.escapedText==="property"}).map(function(doc){return doc.comment}).filter(function(doc){return Boolean(doc)});return{title:title,description:description,examples:examples,params:params,properties:properties,returnType:returnType,members:members,type:getType(statement)}})});return docs.reduce(function(acc,item){return[].concat(_toConsumableArray(acc),_toConsumableArray(item))},[])}export function getAllDocs(){return _getAllDocs.apply(this,arguments)}function _getAllDocs(){_getAllDocs=_asyncToGenerator(_regeneratorRuntime.mark(function _callee(){var pattern,files,_args=arguments;return _regeneratorRuntime.wrap(function _callee$(_context){while(1){switch(_context.prev=_context.next){case 0:pattern=_args.length>0&&_args[0]!==undefined?_args[0]:["./src/**/*.(ts|tsx)","!**/__tests__"];_context.next=3;return glob(pattern);case 3:files=_context.sent;return _context.abrupt("return",getDocs(files));case 5:case"end":return _context.stop();}}},_callee)}));return _getAllDocs.apply(this,arguments)}export function createMatcher(name){return new RegExp("(<!-- ".concat(name," START -->\\s*)([\\S\\s]*)(\\s*<!-- ").concat(name," END -->)"))}export default function generate(){return _generate.apply(this,arguments)}function _generate(){_generate=_asyncToGenerator(_regeneratorRuntime.mark(function _callee2(){var options,_options$matcher,matcher,pattern,_options$headerDepth,headerDepth,docs,markdown,readme,_args2=arguments;return _regeneratorRuntime.wrap(function _callee2$(_context2){while(1){switch(_context2.prev=_context2.next){case 0:options=_args2.length>0&&_args2[0]!==undefined?_args2[0]:{};_options$matcher=options.matcher,matcher=_options$matcher===void 0?createMatcher("INSERT GENERATED DOCS"):_options$matcher,pattern=options.pattern,_options$headerDepth=options.headerDepth,headerDepth=_options$headerDepth===void 0?3:_options$headerDepth;_context2.next=4;return getAllDocs(pattern);case 4:docs=_context2.sent;markdown=docs.map(function(doc){return generateMarkdown(doc,headerDepth)});readme=fs.readFileSync("./README.md","utf8");if(readme.match(matcher)){readme=readme.replace(matcher,"$1".concat(markdown.join("\n"),"$3"));fs.writeFileSync("./README.md",prettier.format(readme,{parser:"markdown",singleQuote:true}))}case 8:case"end":return _context2.stop();}}},_callee2)}));return _generate.apply(this,arguments)}
//# sourceMappingURL=index.js.map