"use strict";var _interopRequireDefault=require("@babel/runtime/helpers/interopRequireDefault");Object.defineProperty(exports,"__esModule",{value:true});exports.generateMarkdown=generateMarkdown;exports.getAllDocs=getAllDocs;exports.createMatcher=createMatcher;exports["default"]=generate;var _regenerator=_interopRequireDefault(require("@babel/runtime/regenerator"));var _asyncToGenerator2=_interopRequireDefault(require("@babel/runtime/helpers/asyncToGenerator"));var _toConsumableArray2=_interopRequireDefault(require("@babel/runtime/helpers/toConsumableArray"));var _slicedToArray2=_interopRequireDefault(require("@babel/runtime/helpers/slicedToArray"));var _typescript=_interopRequireDefault(require("typescript"));var _fs=_interopRequireDefault(require("fs"));var _prettier=_interopRequireDefault(require("prettier"));var _fastGlob=_interopRequireDefault(require("fast-glob"));var printer=_typescript["default"].createPrinter({newLine:_typescript["default"].NewLineKind.LineFeed});function getJsDocComment(statement){return statement.jsDoc&&statement.jsDoc[0]?statement.jsDoc[0].comment:""}function isArrowConst(statement){return Boolean(_typescript["default"].isVariableStatement(statement)&&statement.declarationList.declarations[0].initializer&&_typescript["default"].isArrowFunction(statement.declarationList.declarations[0].initializer))}function getType(statement){if(isArrowConst(statement)||_typescript["default"].isFunctionLike(statement)){return"function"}if(_typescript["default"].isTypeAliasDeclaration(statement)){return"type"}if(_typescript["default"].isClassDeclaration(statement)){return"class"}if(_typescript["default"].isInterfaceDeclaration(statement)){return"interface"}if(_typescript["default"].isVariableStatement(statement)){if(statement.declarationList.declarations[0].type){return"variable: ".concat(printer.printNode(_typescript["default"].EmitHint.Unspecified,statement.declarationList.declarations[0].type,statement.getSourceFile()))}return"variable"}}function print(param){return printer.printNode(_typescript["default"].EmitHint.Unspecified,param,param.getSourceFile())}function generateMarkdown(doc){var headerDepth=arguments.length>1&&arguments[1]!==undefined?arguments[1]:3;var result="".concat(Array(headerDepth).fill("#").join("")," `").concat(doc.title,"` (").concat(doc.type,")\n\n");if(doc.description){result+="".concat(doc.description,"\n\n")}if(doc.params&&doc.params.length>0){result+="**Parameters:**\n\n";doc.params.forEach(function(param){result+="- ".concat(param.name," ").concat(param.type?"(`".concat(param.type,"`) "):"").concat(param.description?"- ".concat(param.description):"","\n")});result+="\n"}if(doc.properties&&doc.properties.length>0){result+="**Properties:**\n\n";doc.properties.forEach(function(property){result+="- ".concat(property,"\n")});result+="\n"}if(doc.members&&doc.members.length>0){result+="**Members:**\n\n";doc.members.forEach(function(member){result+="- ".concat(member,"\n")});result+="\n"}if(doc.returnType){result+="**returns:** ".concat(doc.returnType,"\n\n")}if(doc.examples&&doc.examples.length>0){doc.examples.forEach(function(example){result+="".concat(example.includes("```")?example:"```tsx\n".concat(example,"\n```\n"),"\n")});result+="\n"}return result}function getDocs(filenames){var program=_typescript["default"].createProgram({rootNames:filenames,options:{}});var checker=program.getTypeChecker();function getParamType(doc,statement){var name=print(doc.name);var fn=isArrowConst(statement)?statement.declarationList.declarations[0].initializer:statement;if(!fn||!_typescript["default"].isFunctionLike(fn)){return""}var paramType=fn.parameters.find(function(param){return print(param.name)===name});return paramType?checker.typeToString(checker.getTypeAtLocation(paramType)):""}var docs=program.getSourceFiles().filter(function(file){return!file.isDeclarationFile}).map(function(file){return file.statements.filter(function(s){return Boolean(s.modifiers&&s.modifiers.find(function(e){return e.kind===_typescript["default"].SyntaxKind.ExportKeyword})&&(_typescript["default"].isVariableStatement(s)||_typescript["default"].isFunctionLike(s)||_typescript["default"].isTypeAliasDeclaration(s)||_typescript["default"].isClassDeclaration(s)||_typescript["default"].isInterfaceDeclaration(s)))}).map(function(statement){var title=_typescript["default"].isVariableStatement(statement)?print(statement.declarationList.declarations[0].name):statement.name&&print(statement.name)||"";var description=getJsDocComment(statement);var jsDocs=_typescript["default"].getJSDocTags(statement);var returnType;var params=jsDocs.filter(_typescript["default"].isJSDocParameterTag).map(function(doc){return{name:print(doc.name),description:doc.comment?doc.comment.replace(/^- /,""):"",type:getParamType(doc,statement)}});if(_typescript["default"].isFunctionLike(statement)){statement.parameters.forEach(function(param){var paramName=print(param.name);if(params.find(function(p){return p.name===paramName})){return}params.push({name:paramName,type:checker.typeToString(checker.getTypeAtLocation(param))})});var type=checker.getTypeAtLocation(statement);var _type$getCallSignatur=type.getCallSignatures().map(function(sig){return checker.typeToString(checker.getReturnTypeOfSignature(sig))});var _type$getCallSignatur2=(0,_slicedToArray2["default"])(_type$getCallSignatur,1);returnType=_type$getCallSignatur2[0]}var members=[];if(_typescript["default"].isInterfaceDeclaration(statement)){members=statement.members.map(function(member){var memberDescription=getJsDocComment(member);return"".concat(print(member.name).replace(/\/\*\*.*\*\/\s+(\S+)/,"$1")," (`").concat(checker.typeToString(checker.getTypeAtLocation(member)),"`)").concat(memberDescription?" - ".concat(memberDescription):"")})}var examples=jsDocs.filter(function(doc){return doc.tagName.escapedText==="example"}).map(function(doc){return doc.comment}).filter(function(doc){return Boolean(doc)});var properties=jsDocs.filter(function(doc){return doc.tagName.escapedText==="property"}).map(function(doc){return doc.comment}).filter(function(doc){return Boolean(doc)});return{title:title,description:description,examples:examples,params:params,properties:properties,returnType:returnType,members:members,type:getType(statement)}})});return docs.reduce(function(acc,item){return[].concat((0,_toConsumableArray2["default"])(acc),(0,_toConsumableArray2["default"])(item))},[])}function getAllDocs(){return _getAllDocs.apply(this,arguments)}function _getAllDocs(){_getAllDocs=(0,_asyncToGenerator2["default"])(_regenerator["default"].mark(function _callee(){var pattern,files,_args=arguments;return _regenerator["default"].wrap(function _callee$(_context){while(1){switch(_context.prev=_context.next){case 0:pattern=_args.length>0&&_args[0]!==undefined?_args[0]:["./src/**/*.(ts|tsx)","!**/__tests__"];_context.next=3;return(0,_fastGlob["default"])(pattern);case 3:files=_context.sent;return _context.abrupt("return",getDocs(files));case 5:case"end":return _context.stop();}}},_callee)}));return _getAllDocs.apply(this,arguments)}function createMatcher(name){return new RegExp("(<!-- ".concat(name," START -->\\s*)([\\S\\s]*)(\\s*<!-- ").concat(name," END -->)"))}function generate(){return _generate.apply(this,arguments)}function _generate(){_generate=(0,_asyncToGenerator2["default"])(_regenerator["default"].mark(function _callee2(){var options,_options$matcher,matcher,pattern,_options$headerDepth,headerDepth,docs,markdown,readme,_args2=arguments;return _regenerator["default"].wrap(function _callee2$(_context2){while(1){switch(_context2.prev=_context2.next){case 0:options=_args2.length>0&&_args2[0]!==undefined?_args2[0]:{};_options$matcher=options.matcher,matcher=_options$matcher===void 0?createMatcher("INSERT GENERATED DOCS"):_options$matcher,pattern=options.pattern,_options$headerDepth=options.headerDepth,headerDepth=_options$headerDepth===void 0?3:_options$headerDepth;_context2.next=4;return getAllDocs(pattern);case 4:docs=_context2.sent;markdown=docs.map(function(doc){return generateMarkdown(doc,headerDepth)});readme=_fs["default"].readFileSync("./README.md","utf8");if(readme.match(matcher)){readme=readme.replace(matcher,"$1".concat(markdown.join("\n"),"$3"));_fs["default"].writeFileSync("./README.md",_prettier["default"].format(readme,{parser:"markdown",singleQuote:true}))}case 8:case"end":return _context2.stop();}}},_callee2)}));return _generate.apply(this,arguments)}
//# sourceMappingURL=index.js.map